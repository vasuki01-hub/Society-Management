<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Society Maintenance & Expenses Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Firebase Compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg: #f4f6f9;
            --container-bg: white;
            --text: #333;
            --heading: #2c3e50;
            --border: #ddd;
            --stat-bg: #ecf0f1;
            --table-header: #f1f1f1;
            --month-total-bg: #ecf0f1;
            --all-time-total-bg: #2c3e50;
            --all-time-total-text: white;
            --report-bg: #f0f8ff;
            --input-border: #ccc;
            --no-data: #777;
            --shadow: rgba(0,0,0,0.1);
            --btn-bg: #3498db;
            --btn-hover: #2980b9;
        }
        body.dark-mode {
            --bg: #121212;
            --container-bg: #1e1e1e;
            --text: #e0e0e0;
            --heading: #f1f1f1;
            --border: #444;
            --stat-bg: #2d2d2d;
            --table-header: #333;
            --month-total-bg: #2d2d2d;
            --all-time-total-bg: #bb86fc;
            --all-time-total-text: #121212;
            --report-bg: #252525;
            --input-border: #555;
            --no-data: #999;
            --shadow: rgba(0,0,0,0.4);
            --btn-bg: #bb86fc;
            --btn-hover: #9b59b6;
        }
        * { box-sizing: border-box; margin: 3px; padding: 0; transition: background 0.3s, color 0.3s; }
        body {
            font-size: x-small;
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: var(--container-bg);
            border-radius: 10px;
            box-shadow: 0 0 15px var(--shadow);
        }
        header { text-align: center; margin-bottom: 30px; position: relative; }
        h1 { color: var(--heading); }
        .header-controls {
            position: relative;
            top: 0;
            right: 0;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .language-selector select {
            padding: 8px 12px;
            font-size: 0.8em;
            border-radius: 15px;
            border: 1px solid var(--input-border);
            background: var(--container-bg);
            color: var(--text);
        }
        .theme-toggle button {
            cursor: pointer;
            padding: 8px 12px;
            font-size: 0.9em;
            border-radius: 15px;
            border: 1px solid var(--input-border);
            background: var(--container-bg);
            color: var(--text);
        }
        h2 { padding-left: 7px; border-radius: 100px; background: bisque; margin: 30px 0 15px; color: #000000; border-bottom: 2px solid var(--border); padding-bottom: 8px; }
        h3.month-heading {
            background: #e67e22;
            color: white;
            padding: 12px 18px;
            border-radius: 50px;
            margin: 35px 0 20px 0;
            font-size: 1.4em;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        h3.floor-heading {
            background: #27ae60;
            color: white;
            padding: 10px 16px;
            border-radius: 30px;
            margin: 25px 0 15px 0;
            font-size: 1.2em;
            font-weight: bold;
            display: inline-block;
        }
        .dashboard .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat {
            flex: 1;
            min-width: 200px;
            background: var(--stat-bg);
            padding: 25px;
            border-radius: 8px;
            text-align: center;
        }
        .stat h3 { margin-bottom: 10px; font-size: 1.1em; }
        .stat p { font-size: 2em; font-weight: bold; color: #ff8300; }
        .tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        .tab-btn {
            padding: 14px 24px;
            background: #1c59d9;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            flex: 1;
        }
        .tab-btn.active { background: #121212; color: white; }
        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--stat-bg);
            border-radius: 8px;
        }
        input, select, button, textarea {
            padding: 10px;
            border: 2.5px solid var(--input-border);
            border-radius: 20px;
            font-size: 0.6rem;
            background: var(--container-bg);
            color: var(--text);
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button { background: #09c510; color: white; cursor: pointer; }
        button:hover { background: rgb(58, 57, 56); }
        .filter {
            margin: 20px 0;
            padding: 15px;
            background: var(--report-bg);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .filter label { font-weight: bold; margin-right: 10px; }
        .filter select { padding: 10px; font-size: 1em; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            margin-bottom: 30px;
        }
        th, td {
            padding: 8px 10px;
            border: 1px solid var(--border);
            text-align: left;
            vertical-align: middle;
            font-size: 0.95em;
        }
        th { background: var(--table-header); font-weight: bold; }
        .amount {
            font-family: 'DejaVu Sans', Arial, sans-serif;
            white-space: nowrap;
            text-align: right;
        }
        .month-total {
            font-weight: bold;
            background: var(--month-total-bg);
            text-align: right;
            padding: 15px;
            font-size: 1.2em;
        }
        .all-time-total {
            font-weight: bold;
            background: var(--all-time-total-bg);
            color: var(--all-time-total-text);
            text-align: right;
            padding: 20px;
            font-size: 1.5em;
            border-radius: 8px;
        }
        .action-btn {
            padding: 4px 8px;
            margin: 0 4px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .edit-btn { background: #f39c12; color: white; }
        .save-btn { background: #27ae60; color: white; }
        .cancel-btn { background: #95a5a6; color: white; }
        .delete-btn { background: #e74c3c; color: white; }
        .photo-btn { background: #3498db; color: white; }
        .delete-photo-btn { background: #e74c3c; color: white; font-size: 1.2em; padding: 2px 6px; border-radius: 50%; }
        .editable-input {
            padding: 8px;
            width: 100%;
            border: 1px solid #3498db;
            border-radius: 4px;
            background: var(--container-bg);
            color: var(--text);
        }
        .no-data {
            text-align: center;
            padding: 30px;
            color: var(--no-data);
            font-style: italic;
        }
        .occupancy-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
        }
        .occupied { background: #d5f5e3; color: #27ae60; }
        .vacant { background: #fadbd8; color: #e74c3c; }
        .report-summary {
            background: var(--report-bg);
            padding: 30px;
            border-radius: 8px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            justify-items: center;
        }
        .chart-container {
            position: relative;
            width: 260px;
            height: 260px;
        }
        .chart-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: bold;
            color: var(--text);
        }
        .flat-progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .flat-item {
            background: var(--stat-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow);
            text-align: center;
        }
        .flat-name { font-weight: bold; margin-bottom: 10px; }
        .flat-progress-bar {
            height: 20px;
            background: var(--table-header);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .flat-progress-fill {
            height: 100%;
            background: #27ae60;
            width: 0%;
            transition: width 1.5s ease;
        }
        .flat-percent { font-size: 1.2em; font-weight: bold; }
        .category-breakdown { margin-top: 20px; }
        .category-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: var(--stat-bg);
            margin-bottom: 8px;
            border-radius: 5px;
            box-shadow: 0 1px 3px var(--shadow);
        }
        .pdf-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .pdf-btn {
            background: #e74c3c;
            padding: 12px 24px;
            font-size: 1.1em;
        }
        @media (max-width: 768px) {
            form { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab-btn { width: 100%; }
            .report-summary { grid-template-columns: 1fr; }
            .pdf-buttons { flex-direction: column; align-items: center; }
            .header-controls { flex-direction: column; }
        }
        #login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgb(250, 242, 229);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .login-box {
            background: var(--container-bg);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 320px;
            text-align: center;
        }
        .login-box h2 {
            margin-bottom: 30px;
            color: var(--heading);
        }
        .login-box input {
            width: 100%;
            margin-bottom: 20px;
        }
        .login-box button {
            width: 100%;
            padding: 14px;
            font-size: 1.1em;
        }
        #main-app { display: none; }
        .logout-btn {
            background: #e74c3c;
            margin-top: 0;
        }
        .logout-btn:hover {
            background: #c0392b;
        }
        .sync-status {
            text-align: center;
            font-size: 0.9em;
            margin: 10px 0;
            color: #27ae60;
        }

        /* Photo Modal */
        .photo-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }
        .photo-modal-content {
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }
        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        .photo-modal-caption {
            color: white;
            margin-top: 15px;
            font-size: 1.1em;
        }
        .photo-nav {
            color: white;
            font-size: 30px;
            cursor: pointer;
            margin: 0 30px;
            user-select: none;
        }

        /* Edit mode photo preview */
        .edit-photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .edit-photo-item {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .edit-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #ddd;
        }
        .edit-photo-item .delete-photo-btn {
            position: absolute;
            top: -8px;
            right: -8px;
        }
    </style>
</head>
<body>
    <!-- Photo Modal -->
    <div id="photo-modal" class="photo-modal">
        <span class="photo-modal-close" onclick="closePhotoModal()">&times;</span>
        <div style="display: flex; align-items: center;">
            <span class="photo-nav" onclick="prevPhoto()">&#10094;</span>
            <img id="modal-photo" class="photo-modal-content" alt="Expense Photo">
            <span class="photo-nav" onclick="nextPhoto()">&#10095;</span>
        </div>
        <div id="photo-caption" class="photo-modal-caption"></div>
    </div>

    <!-- Login Page -->
    <div id="login-page">
        <div class="login-box">
            <h2>Society Manager Login</h2>
            <input type="email" id="login-email" placeholder="Enter Email (optional)" style="margin-bottom: 10px;">
            <input type="password" id="login-password" placeholder="Enter Password" autocomplete="off">
            <button id="login-btn">Login</button>
            <p id="login-error" style="color:red; margin-top:15px; display:none;">Incorrect password!</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="container">
        <header>
            <h1 data-lang="title">Society Maintenance & Expenses Manager</h1>
            <div class="header-controls">
                <div class="language-selector">
                    <select id="language-select" onchange="changeLanguage()">
                        <option value="en">English</option>
                        <option value="hi">हिंदी</option>
                        <option value="gu">ગુજરાતી</option>
                    </select>
                </div>
                <div class="theme-toggle">
                    <button onclick="toggleTheme()">Dark Mode</button>
                </div>
                <button id="logout-btn" class="logout-btn" style="display:none;">Logout</button>
            </div>
        </header>

        <div class="sync-status" id="sync-status">Loading data from cloud...</div>

        <section class="dashboard">
            <h2 data-lang="dashboard">Overall Dashboard (All Time)</h2>
            <div class="stats">
                <div class="stat">
                    <h3 data-lang="total_expenses">Total Expenses</h3>
                    <p id="total-expenses" class="amount" style="color: red;">₹0.00</p>
                </div>
                <div class="stat">
                    <h3 data-lang="total_collected">Total Collected</h3>
                    <p id="total-collected" class="amount">₹0.00</p>
                </div>
                <div class="stat">
                    <h3 data-lang="balance">Current Balance</h3>
                    <p id="balance" class="amount">₹0.00</p>
                </div>
            </div>
        </section>

        <section class="tabs">
            <button class="tab-btn active" onclick="openTab('dashboard')" data-lang="Dashboard">Dashboard</button>
            <button class="tab-btn" onclick="openTab('expenses')" data-lang="add_expense">Add Expense</button>
            <button class="tab-btn" onclick="openTab('payments')" data-lang="Add_Maintenance">Add Maintenance</button>
            <button class="tab-btn" onclick="openTab('lists')" data-lang="view_details">View Details</button>
        </section>

        <section id="dashboard" class="tab-content">
            <div class="filter">
                <div>
                    <label for="report-month" data-lang="select_month_year">Select Month & Year:</label>
                    <select id="report-month" onchange="renderReports()"></select>
                </div>
                <div class="pdf-buttons">
                    <button class="action-btn pdf-btn" onclick="generateExpensePDF()" data-lang="Download_Expense_Report_PDF">Download Expense Report PDF</button>
                    <button class="action-btn pdf-btn" onclick="generateInvoicePDF()" data-lang="Download_Maintenance_Report_PDF">Download Maintenance Report PDF</button>
                </div>
            </div>
            <h2><span data-lang="monthly_report">Dashboard</span> - <span id="report-month-title">Current Month</span></h2>
            <div class="report-summary">
                <div>
                    <h3 data-lang="expenses_vs_collected">Expenses vs Collected</h3>
                    <div class="chart-container">
                        <canvas id="expensesChart"></canvas>
                        <div class="chart-text" id="expensesText">₹0 / ₹0</div>
                    </div>
                </div>
                <div>
                    <h3 data-lang="Total_Balance_Used">Total Balance Used</h3>
                    <div class="chart-container">
                        <canvas id="overallProgressChart"></canvas>
                        <div class="chart-text" id="overallProgressText">0%</div>
                    </div>
                </div>
                <div>
                    <h3 data-lang="balance_status">Balance Status</h3>
                    <div class="chart-container">
                        <canvas id="balanceChart"></canvas>
                        <div class="chart-text" id="balanceText">₹0</div>
                    </div>
                </div>
            </div>
            <h2 data-lang="flat_wise_progress">Flat-wise Collection Progress</h2>
            <div class="flat-progress-grid" id="flat-progress-container"></div>
            <h2 style="margin-top:40px;" data-lang="expense_breakdown">Expense Breakdown by Category</h2>
            <div class="category-breakdown" id="category-breakdown"></div>
        </section>

        <section id="expenses" class="tab-content" style="display:none;">
            <h2 data-lang="add_society_expense">Add Society Expense</h2>
            <form id="expense-form">
                <input type="date" id="exp-date" required>
                <input type="text" id="exp-desc" placeholder="Description" data-lang-placeholder="description_placeholder">
                <select id="exp-category" required>
                    <option value="" disabled selected data-lang="select_category">Select Category</option>
                    <option>Utilities</option>
                    <option>Repairs</option>
                    <option>Security</option>
                    <option>Cleaning</option>
                    <option>Staff Salary</option>
                    <option>Events</option>
                    <option>Other</option>
                </select>
                <input type="number" id="exp-amount" placeholder="Amount (₹)" data-lang-placeholder="amount_placeholder">
                <input type="file" id="exp-photo" accept="image/*" multiple>
                <button type="submit" data-lang="add_expense_btn">Add Expense</button>
            </form>
        </section>

        <section id="payments" class="tab-content" style="display:none;">
            <h2 data-lang="add_maintenance_payment">Add Maintenance Payment</h2>
            <form id="payment-form">
                <select id="pay-flat" required>
                    <option value="" disabled selected data-lang="select_flat">Select Flat No.</option>
                    <optgroup label="1st Floor">
                        <option>109</option><option>110</option><option>111</option><option>112</option>
                    </optgroup>
                    <optgroup label="2nd Floor">
                        <option>209</option><option>210</option><option>211</option><option>212</option>
                    </optgroup>
                    <optgroup label="3rd Floor">
                        <option>309</option><option>310</option><option>311</option><option>312</option>
                    </optgroup>
                    <optgroup label="4th Floor">
                        <option>409</option><option>410</option><option>411</option><option>412</option>
                    </optgroup>
                </select>
                <input type="text" id="pay-name" placeholder="Member Name (leave blank if vacant)" data-lang-placeholder="member_name_placeholder">
                <input type="text" id="pay-contact" placeholder="Contact No. (optional)" data-lang-placeholder="contact_no_placeholder">
                <div style="grid-column: span 2; margin: 10px 0;">
                    <label><input type="checkbox" id="pay-vacant" onchange="toggleVacant()"> <span data-lang="mark_vacant">Mark as Vacant (no owner name)</span></label>
                </div>
                <input type="date" id="pay-date" required>
                <input type="number" id="pay-amount" placeholder="Amount Paid (₹)" data-lang-placeholder="amount_paid_placeholder">
                <button type="submit" data-lang="add_payment_btn">Add Maintenance</button>
            </form>
        </section>

        <section id="lists" class="tab-content" style="display:none;">
            <div class="filter">
                <label for="list-month" data-lang="view_month">View Month:</label>
                <select id="list-month" onchange="renderLists()"></select>
            </div>
            <h2><span data-lang="expenses">Expenses</span> - <span id="list-month-title">All Time</span></h2>
            <div id="expenses-container"></div>
            <h2><span data-lang="Maintenance_By_Floor">Maintenance By Floor</span> - <span id="list-month-title2">All Time</span></h2>
            <div id="floor-payments-container"></div>
        </section>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDbBlEekQYG81mdbfGy_7-wQMdz-OZ-CLM",
            authDomain: "studio-6643913702-f80ae.firebaseapp.com",
            projectId: "studio-6643913702-f80ae",
            storageBucket: "studio-6643913702-f80ae.firebasestorage.app",
            messagingSenderId: "726461626607",
            appId: "1:726461626607:web:63773739648732a252c31a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const DATA_DOC = "society/data";
        const APP_PASSWORD = "GB3";

        let expenses = [];
        let payments = [];
        let flatStatus = {};
        let expensesChart = null, overallProgressChart = null, balanceChart = null;

        let currentPhotoIndex = 0;
        let currentPhotosArray = [];

        const allFlats = ['109','110','111','112','209','210','211','212','309','310','311','312','409','410','411','412'];
        const floorMap = {
            '109': '1st Floor', '110': '1st Floor', '111': '1st Floor', '112': '1st Floor',
            '209': '2nd Floor', '210': '2nd Floor', '211': '2nd Floor', '212': '2nd Floor',
            '309': '3rd Floor', '310': '3rd Floor', '311': '3rd Floor', '312': '3rd Floor',
            '409': '4th Floor', '410': '4th Floor', '411': '4th Floor', '412': '4th Floor'
        };
        const floors = ['1st Floor', '2nd Floor', '3rd Floor', '4th Floor'];

        const translations = {
            en: {
                title: "Society Maintenance & Expenses Manager",
                dashboard: "Overall Dashboard (All Time)",
                total_expenses: "Total Expenses",
                total_collected: "Total Collected",
                balance: "Current Balance",
                add_expense: "Add Expense",
                Add_Maintenance: "Add Maintenance",
                view_details: "View Details",
                Dashboard: "Dashboard",
                add_society_expense: "Add Society Expense",
                description_placeholder: "Description",
                select_category: "Select Category",
                amount_placeholder: "Amount (₹)",
                add_expense_btn: "Add Expense",
                add_maintenance_payment: "Add Maintenance Payment",
                select_flat: "Select Flat No.",
                member_name_placeholder: "Member Name (leave blank if vacant)",
                contact_no_placeholder: "Contact No. (optional)",
                mark_vacant: "Mark as Vacant (no owner name)",
                amount_paid_placeholder: "Amount Paid (₹)",
                add_payment_btn: "Add Payment",
                view_month: "View Month:",
                expenses: "Expenses",
                Maintenance_By_Floor: "Maintenance By Floor",
                monthly_report: "Dashboard",
                select_month_year: "Select Month & Year:",
                expenses_vs_collected: "Expenses vs Collected",
                Total_Balance_Used: "Total Balance Used",
                balance_status: "Balance Status",
                flat_wise_progress: "Flat-wise Collection Progress",
                expense_breakdown: "Expense Breakdown by Category",
                occupied: "Occupied",
                vacant: "Vacant",
                toggle: "Toggle",
                Download_Expense_Report_PDF: "Download Expense Report PDF",
                Download_Maintenance_Report_PDF: "Download Maintenance Report PDF",
                month_total: "Month Total: ",
                all_time_total: "All Time Total Expenses: ",
                view_photos: "View Photos",
                no_photos: "No Photos"
            },
            hi: {
                title: "सोसायटी मेंटेनेंस और खर्च प्रबंधक",
                dashboard: "कुल डैशबोर्ड (सभी समय)",
                total_expenses: "कुल खर्च",
                total_collected: "कुल एकत्रित",
                balance: "वर्तमान शेष",
                add_expense: "खर्च जोड़ें",
                Add_Maintenance: "रखरखाव जोड़ें",
                view_details: "विवरण देखें",
                Dashboard: "डैशबोर्ड",
                add_society_expense: "सोसायटी खर्च जोड़ें",
                description_placeholder: "विवरण",
                select_category: "श्रेणी चुनें",
                amount_placeholder: "राशि (₹)",
                add_expense_btn: "खर्च जोड़ें",
                add_maintenance_payment: "मेंटेनेंस भुगतान जोड़ें",
                select_flat: "फ्लैट नंबर चुनें",
                member_name_placeholder: "सदस्य का नाम (खाली छोड़ें यदि रिक्त)",
                contact_no_placeholder: "संपर्क नंबर (वैकल्पिक)",
                mark_vacant: "रिक्त चिह्नित करें (कोई मालिक नाम नहीं)",
                amount_paid_placeholder: "भुगतान की गई राशि (₹)",
                add_payment_btn: "भुगतान जोड़ें",
                view_month: "माह देखें:",
                expenses: "खर्च",
                Maintenance_By_Floor: "फर्श द्वारा रखरखाव",
                monthly_report: "डैशबोर्ड",
                select_month_year: "माह और वर्ष चुनें:",
                expenses_vs_collected: "खर्च बनाम एकत्रित",
                Total_Balance_Used: "कुल प्रयुक्त शेष राशि",
                balance_status: "शेष स्थिति",
                flat_wise_progress: "फ्लैट अनुसार संग्रह प्रगति",
                expense_breakdown: "श्रेणी अनुसार खर्च विभाजन",
                occupied: "व्याप्त",
                vacant: "रिक्त",
                toggle: "टॉगल",
                Download_Expense_Report_PDF: "व्यय रिपोर्ट पीडीएफ डाउनलोड करें",
                Download_Maintenance_Report_PDF: "रखरखाव रिपोर्ट पीडीएफ डाउनलोड करें",
                month_total: "माह कुल: ",
                all_time_total: "सभी समय कुल खर्च: ",
                view_photos: "फोटो देखें",
                no_photos: "कोई फोटो नहीं"
            },
            gu: {
                title: "સોસાયટી મેઇન્ટેનન્સ અને ખર્ચ મેનેજર",
                dashboard: "કુલ ડેશબોર્ડ (બધા સમય)",
                total_expenses: "કુલ ખર્ચ",
                total_collected: "કુલ એકત્રિત",
                balance: "વર્તમાન બેલેન્સ",
                add_expense: "ખર્ચ ઉમેરો",
                Add_Maintenance: "ઉમેરો_જાળ",
                view_details: "વિગતો જુઓ",
                Dashboard: "ડેશબોર્ડ",
                add_society_expense: "સોસાયટી ખર્ચ ઉમેરો",
                description_placeholder: "વર્ણન",
                select_category: "શ્રેણી પસંદ કરો",
                amount_placeholder: "રકમ (₹)",
                add_expense_btn: "ખર્ચ ઉમેરો",
                add_maintenance_payment: "મેઇન્ટેનન્સ ચુકવણી ઉમેરો",
                select_flat: "ફ્લેટ નંબર પસંદ કરો",
                member_name_placeholder: "સભ્યનું નામ (ખાલી છોડો જો ખાલી હોય)",
                contact_no_placeholder: "સંપર્ક નંબર (વૈકલ્પિક)",
                mark_vacant: "ખાલી તરીકે ચિહ્નિત કરો (કોઈ માલિકનું નામ નહીં)",
                amount_paid_placeholder: "ચુકવેલ રકમ (₹)",
                add_payment_btn: "ચુકવણી ઉમેરો",
                view_month: "મહિનો જુઓ:",
                expenses: "ખર્ચ",
                Maintenance_By_Floor: "ફ્લોર દ્વારા જાળવણી",
                monthly_report: "ડેશબોર્ડ",
                select_month_year: "મહિનો અને વર્ષ પસંદ કરો:",
                expenses_vs_collected: "ખર્ચ વિરુદ્ધ એકત્રિત",
                Total_Balance_Used: "કુલ સંતુલન વપરાય છે",
                balance_status: "બેલેન્સ સ્થિતિ",
                flat_wise_progress: "ફ્લેટ પ્રમાણે સંગ્રહ પ્રગતિ",
                expense_breakdown: "શ્રેણી પ્રમાણે ખર્ચ વિભાજન",
                occupied: "વ્યાપ્ત",
                vacant: "ખાલી",
                toggle: "ટૉગલ",
                Download_Expense_Report_PDF: "ડાઉનલોડ_એક્સપેન્સ_રેપોર્ટ_પીડીએફ",
                Download_Maintenance_Report_PDF: "જાળવણી અહેવાલ પીડીએફ ડાઉનલોડ કરો",
                month_total: "મહિનો કુલ: ",
                all_time_total: "બધા સમય કુલ ખર્ચ: ",
                view_photos: "ફોટો જુઓ",
                no_photos: "કોઈ ફોટા નથી"
            }
        };

        async function loadData() {
            try {
                const doc = await db.doc(DATA_DOC).get();
                if (doc.exists) {
                    const data = doc.data();
                    expenses = data.expenses || [];
                    payments = data.payments || [];
                    flatStatus = data.flatStatus || {};
                }
                document.getElementById('sync-status').textContent = "Data synced successfully!";
                document.getElementById('sync-status').style.color = "#27ae60";
            } catch (err) {
                console.error("Load error:", err);
                document.getElementById('sync-status').textContent = "Offline – changes will sync later";
                document.getElementById('sync-status').style.color = "#e67e22";
            }
            initApp();
        }

        async function saveDataToCloud() {
            try {
                await db.doc(DATA_DOC).set({
                    expenses,
                    payments,
                    flatStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (err) {
                console.error("Save error:", err);
            }
        }

        function saveData() {
            saveDataToCloud();
            updateDashboard();
            renderLists();
            renderReports();
        }

        function formatIndianRupees(amount) {
            amount = parseFloat(amount) || 0;
            let [integer, decimal] = amount.toFixed(2).split('.');
            integer = integer.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return '₹' + integer + '.' + decimal;
        }

        function formatRupeesNoSymbol(amount) {
            amount = parseFloat(amount) || 0;
            let [integer, decimal] = amount.toFixed(2).split('.');
            integer = integer.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return integer + '.' + decimal;
        }

        function changeLanguage() {
            const lang = document.getElementById('language-select').value;
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });
            localStorage.setItem('preferredLanguage', lang);
            renderLists();
            renderReports();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const button = document.querySelector('.theme-toggle button');
            if (document.body.classList.contains('dark-mode')) {
                button.textContent = 'Light Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                button.textContent = 'Dark Mode';
                localStorage.setItem('theme', 'light');
            }
        }

        function toggleVacant() {
            const nameInput = document.getElementById('pay-name');
            const contactInput = document.getElementById('pay-contact');
            if (document.getElementById('pay-vacant').checked) {
                nameInput.value = '';
                contactInput.value = '';
                nameInput.disabled = true;
                contactInput.disabled = true;
            } else {
                nameInput.disabled = false;
                contactInput.disabled = false;
            }
        }

        function getMonthOptions() {
            const months = new Set();
            [...expenses, ...payments].forEach(item => {
                if (item.date) {
                    const date = new Date(item.date);
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    months.add(key);
                }
            });
            const today = new Date();
            const currentKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            months.add(currentKey);
            return Array.from(months).sort().reverse();
        }

        function populateMonthSelects() {
            const options = getMonthOptions();
            ['list-month', 'report-month'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="all">All Time</option>';
                options.forEach(key => {
                    const [year, month] = key.split('-');
                    const date = new Date(year, month - 1);
                    const optionText = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = optionText;
                    select.appendChild(opt);
                });
            });
        }

        function getFilteredData(monthKey) {
            if (monthKey === 'all') return { exp: expenses, pay: payments };
            const [year, month] = monthKey.split('-');
            return {
                exp: expenses.filter(e => new Date(e.date).getFullYear() == year && (new Date(e.date).getMonth() + 1) == month),
                pay: payments.filter(p => new Date(p.date).getFullYear() == year && (new Date(p.date).getMonth() + 1) == month)
            };
        }

        function updateDashboard() {
            const totalExp = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            const totalPay = payments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
            const balance = totalPay - totalExp;
            document.getElementById('total-expenses').textContent = formatIndianRupees(totalExp);
            document.getElementById('total-collected').textContent = formatIndianRupees(totalPay);
            document.getElementById('balance').textContent = formatIndianRupees(balance);
            document.getElementById('balance').style.color = balance >= 0 ? '#27ae60' : '#e74c3c';
        }

        function renderReports() {
            const monthKey = document.getElementById('report-month').value || 'all';
            const { exp, pay } = getFilteredData(monthKey);
            const monthTitle = monthKey === 'all' ? 'All Time' : new Date(monthKey + '-01').toLocaleString('default', { month: 'long', year: 'numeric' });
            document.getElementById('report-month-title').textContent = monthTitle;

            const monthlyExp = exp.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            const monthlyPay = pay.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
            const monthlyBal = monthlyPay - monthlyExp;

            document.getElementById('expensesText').textContent = formatIndianRupees(monthlyExp) + ' / ' + formatIndianRupees(monthlyPay);
            document.getElementById('balanceText').textContent = formatIndianRupees(monthlyBal);
            const overallPercent = monthlyExp > 0 ? (monthlyExp / monthlyPay) * 100 : 0;
            document.getElementById('overallProgressText').textContent = `${overallPercent.toFixed(0)}%`;

            if (expensesChart) expensesChart.destroy();
            if (overallProgressChart) overallProgressChart.destroy();
            if (balanceChart) balanceChart.destroy();

            expensesChart = new Chart(document.getElementById('expensesChart'), {
                type: 'doughnut',
                data: { labels: ['Expenses', 'Collected'], datasets: [{ data: [monthlyExp, monthlyPay], backgroundColor: ['#e74c3c', '#27ae60'], borderWidth: 0 }] },
                options: { responsive: true, cutout: '70%', plugins: { legend: { display: false } } }
            });

            overallProgressChart = new Chart(document.getElementById('overallProgressChart'), {
                type: 'doughnut',
                data: { datasets: [{ data: [overallPercent, 100 - overallPercent], backgroundColor: ['#3498db', '#ecf0f1'], borderWidth: 0 }] },
                options: { responsive: true, cutout: '85%', plugins: { legend: { display: false } } }
            });

            const balanceColor = monthlyBal >= 0 ? '#27ae60' : '#e74c3c';
            balanceChart = new Chart(document.getElementById('balanceChart'), {
                type: 'doughnut',
                data: { datasets: [{ data: monthlyBal >= 0 ? [Math.abs(monthlyBal), 0] : [0, Math.abs(monthlyBal)], backgroundColor: [balanceColor, '#ecf0f1'], borderWidth: 0 }] },
                options: { responsive: true, cutout: '70%', plugins: { legend: { display: false } } }
            });

            const lang = document.getElementById('language-select').value;
            const flatContainer = document.getElementById('flat-progress-container');
            flatContainer.innerHTML = '';
            allFlats.forEach(flat => {
                const flatPayments = pay.filter(p => p.flat === flat);
                const paidAmount = flatPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
                const expectedPerFlat = monthlyExp / 16;
                const percent = expectedPerFlat > 0 ? (paidAmount / expectedPerFlat) * 100 : 0;
                const cappedPercent = Math.min(100, Math.max(0, percent));
                const status = flatStatus[flat] || (flatPayments.some(p => p.name) ? 'occupied' : 'vacant');
                const statusClass = status === 'occupied' ? 'occupied' : 'vacant';
                const statusText = status === 'occupied' ? translations[lang].occupied : translations[lang].vacant;

                const item = document.createElement('div');
                item.className = 'flat-item';
                item.innerHTML = `
                    <div class="flat-name">Flat ${flat} <span class="occupancy-status ${statusClass}" style="font-size:0.8em;">${statusText}</span></div>
                    <div class="flat-progress-bar"><div class="flat-progress-fill" style="width: ${cappedPercent}%;"></div></div>
                    <div class="flat-percent">${cappedPercent.toFixed(0)}% <br><small class="amount">${formatIndianRupees(paidAmount)} paid</small></div>
                `;
                flatContainer.appendChild(item);
            });

            const container = document.getElementById('category-breakdown');
            container.innerHTML = '';
            if (exp.length === 0) {
                container.innerHTML = '<p>No expenses in this period.</p>';
                return;
            }
            const categoryTotals = {};
            exp.forEach(e => {
                const cat = e.category || 'Other';
                categoryTotals[cat] = (categoryTotals[cat] || 0) + parseFloat(e.amount);
            });
            Object.keys(categoryTotals).sort().forEach(cat => {
                const amount = categoryTotals[cat];
                const percentage = monthlyExp > 0 ? ((amount / monthlyExp) * 100).toFixed(1) : 0;
                const div = document.createElement('div');
                div.className = 'category-item';
                div.innerHTML = `<span>${cat}</span><span class="amount">${formatIndianRupees(amount)}</span> <em>(${percentage}%)</em>`;
                container.appendChild(div);
            });
        }

        function renderLists() {
            const lang = document.getElementById('language-select').value;
            const monthKey = document.getElementById('list-month').value || 'all';
            const { exp, pay } = getFilteredData(monthKey);
            const monthTitle = monthKey === 'all' ? 'All Time' : new Date(monthKey + '-01').toLocaleString('default', { month: 'long', year: 'numeric' });
            document.getElementById('list-month-title').textContent = monthTitle;
            document.getElementById('list-month-title2').textContent = monthTitle;

            const expensesContainer = document.getElementById('expenses-container');
            expensesContainer.innerHTML = '';

            // Expenses rendering (unchanged)
            if (monthKey !== 'all') {
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th>Photos</th><th>Actions</th></tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');
                let monthTotal = 0;
                exp.forEach(e => {
                    const globalIdx = expenses.indexOf(e);
                    const hasPhotos = e.photos && e.photos.length > 0;
                    const photoCell = hasPhotos ? `<button class="action-btn photo-btn" onclick="openPhotoModal(${globalIdx})">${translations[lang].view_photos} (${e.photos.length})</button>` : translations[lang].no_photos;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${e.date}</td>
                        <td>${e.desc}</td>
                        <td>${e.category}</td>
                        <td class="amount">${formatIndianRupees(e.amount)}</td>
                        <td>${photoCell}</td>
                        <td>
                            <button class="action-btn edit-btn" data-expense-idx="${globalIdx}">Edit</button>
                            <button class="action-btn delete-btn" data-expense-idx="${globalIdx}">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                    monthTotal += parseFloat(e.amount);
                });
                expensesContainer.appendChild(table);
                const totalDiv = document.createElement('div');
                totalDiv.className = 'month-total';
                totalDiv.innerHTML = translations[lang].month_total + `<span class="amount">${formatIndianRupees(monthTotal)}</span>`;
                expensesContainer.appendChild(totalDiv);
            } else {
                const expensesByMonth = {};
                expenses.forEach(e => {
                    const date = new Date(e.date);
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!expensesByMonth[key]) expensesByMonth[key] = [];
                    expensesByMonth[key].push(e);
                });
                const sortedKeys = Object.keys(expensesByMonth).sort().reverse();
                let grandTotal = 0;
                if (sortedKeys.length === 0) {
                    expensesContainer.innerHTML = '<div class="no-data">No expenses recorded yet.</div>';
                } else {
                    sortedKeys.forEach(key => {
                        const monthExps = expensesByMonth[key];
                        const monthName = new Date(key + '-01').toLocaleString('default', { month: 'long', year: 'numeric' });
                        const monthSection = document.createElement('div');
                        const heading = document.createElement('h3');
                        heading.className = 'month-heading';
                        heading.textContent = monthName;
                        monthSection.appendChild(heading);

                        const table = document.createElement('table');
                        table.innerHTML = `
                            <thead>
                                <tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th>Photos</th><th>Actions</th></tr>
                            </thead>
                            <tbody></tbody>
                        `;
                        const tbody = table.querySelector('tbody');
                        let monthTotal = 0;
                        monthExps.forEach(e => {
                            const globalIdx = expenses.indexOf(e);
                            const hasPhotos = e.photos && e.photos.length > 0;
                            const photoCell = hasPhotos ? `<button class="action-btn photo-btn" onclick="openPhotoModal(${globalIdx})">${translations[lang].view_photos} (${e.photos.length})</button>` : translations[lang].no_photos;
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${e.date}</td>
                                <td>${e.desc}</td>
                                <td>${e.category}</td>
                                <td class="amount">${formatIndianRupees(e.amount)}</td>
                                <td>${photoCell}</td>
                                <td>
                                    <button class="action-btn edit-btn" data-expense-idx="${globalIdx}">Edit</button>
                                    <button class="action-btn delete-btn" data-expense-idx="${globalIdx}">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                            monthTotal += parseFloat(e.amount);
                        });
                        monthSection.appendChild(table);
                        const totalDiv = document.createElement('div');
                        totalDiv.className = 'month-total';
                        totalDiv.innerHTML = translations[lang].month_total + `<span class="amount">${formatIndianRupees(monthTotal)}</span>`;
                        monthSection.appendChild(totalDiv);
                        expensesContainer.appendChild(monthSection);
                        grandTotal += monthTotal;
                    });
                    const grandTotalDiv = document.createElement('div');
                    grandTotalDiv.className = 'all-time-total';
                    grandTotalDiv.innerHTML = translations[lang].all_time_total + `<span class="amount">${formatIndianRupees(grandTotal)}</span>`;
                    expensesContainer.appendChild(grandTotalDiv);
                }
            }

            document.querySelectorAll('[data-expense-idx]').forEach(btn => {
                const idx = parseInt(btn.getAttribute('data-expense-idx'));
                if (btn.classList.contains('edit-btn')) btn.onclick = () => editExpense(idx, btn);
                if (btn.classList.contains('delete-btn')) btn.onclick = () => deleteExpense(idx);
            });

            // Maintenance section - month-wise for "All Time"
            const container = document.getElementById('floor-payments-container');
            container.innerHTML = '';

            if (monthKey === 'all') {
                const paymentsByMonth = {};
                payments.forEach(p => {
                    const date = new Date(p.date);
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!paymentsByMonth[key]) paymentsByMonth[key] = [];
                    paymentsByMonth[key].push(p);
                });

                const sortedKeys = Object.keys(paymentsByMonth).sort().reverse();

                if (sortedKeys.length === 0) {
                    container.innerHTML = '<div class="no-data">No payments recorded yet.</div>';
                } else {
                    sortedKeys.forEach(key => {
                        const monthPayments = paymentsByMonth[key];
                        const monthName = new Date(key + '-01').toLocaleString('default', { month: 'long', year: 'numeric' });

                        const monthSection = document.createElement('div');
                        const monthHeading = document.createElement('h3');
                        monthHeading.className = 'month-heading';
                        monthHeading.textContent = monthName;
                        monthSection.appendChild(monthHeading);

                        floors.forEach(floor => {
                            const floorFlats = allFlats.filter(f => floorMap[f] === floor);
                            const floorSection = document.createElement('div');
                            const floorHeading = document.createElement('h3');
                            floorHeading.className = 'floor-heading';
                            floorHeading.textContent = floor;
                            floorSection.appendChild(floorHeading);

                            const table = document.createElement('table');
                            table.innerHTML = `
                                <thead>
                                    <tr><th>Date</th><th>Flat No.</th><th>Occupancy</th><th>Member Name</th><th>Contact No.</th><th>Amount</th><th>Actions</th></tr>
                                </thead>
                                <tbody></tbody>
                            `;
                            const tbody = table.querySelector('tbody');

                            floorFlats.forEach(flat => {
                                const flatPaymentsInMonth = monthPayments.filter(p => p.flat === flat);
                                const latestPayment = flatPaymentsInMonth.length > 0 ? flatPaymentsInMonth[flatPaymentsInMonth.length - 1] : null;
                                const status = flatStatus[flat] || (latestPayment && latestPayment.name ? 'occupied' : 'vacant');
                                const statusClass = status === 'occupied' ? 'occupied' : 'vacant';
                                const statusText = status === 'occupied' ? translations[lang].occupied : translations[lang].vacant;
                                const contact = latestPayment && latestPayment.contact ? latestPayment.contact : '—';
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${latestPayment ? latestPayment.date : '—'}</td>
                                    <td>${flat}</td>
                                    <td>
                                        <span class="occupancy-status ${statusClass}">${statusText}</span>
                                        <button class="action-btn" onclick="toggleOccupancy('${flat}')">${translations[lang].toggle}</button>
                                    </td>
                                    <td>${latestPayment ? latestPayment.name || '—' : '—'}</td>
                                    <td>${contact}</td>
                                    <td class="amount">${latestPayment ? formatIndianRupees(latestPayment.amount) : '₹0.00'}</td>
                                    <td>${latestPayment ? `<button class="action-btn edit-btn" data-payment-idx="${payments.indexOf(latestPayment)}">Edit</button><button class="action-btn delete-btn" data-payment-idx="${payments.indexOf(latestPayment)}">Delete</button>` : ''}</td>
                                `;
                                tbody.appendChild(row);
                            });

                            floorSection.appendChild(table);
                            monthSection.appendChild(floorSection);
                        });

                        container.appendChild(monthSection);
                    });
                }
            } else {
                floors.forEach(floor => {
                    const floorFlats = allFlats.filter(f => floorMap[f] === floor);
                    const floorSection = document.createElement('div');
                    const heading = document.createElement('h3');
                    heading.className = 'floor-heading';
                    heading.textContent = floor;
                    floorSection.appendChild(heading);
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr><th>Date</th><th>Flat No.</th><th>Occupancy</th><th>Member Name</th><th>Contact No.</th><th>Amount</th><th>Actions</th></tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    const tbody = table.querySelector('tbody');
                    floorFlats.forEach(flat => {
                        const flatPayments = pay.filter(p => p.flat === flat);
                        const latestPayment = flatPayments.length > 0 ? flatPayments[flatPayments.length - 1] : null;
                        const status = flatStatus[flat] || (latestPayment && latestPayment.name ? 'occupied' : 'vacant');
                        const statusClass = status === 'occupied' ? 'occupied' : 'vacant';
                        const statusText = status === 'occupied' ? translations[lang].occupied : translations[lang].vacant;
                        const contact = latestPayment && latestPayment.contact ? latestPayment.contact : '—';
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${latestPayment ? latestPayment.date : '—'}</td>
                            <td>${flat}</td>
                            <td>
                                <span class="occupancy-status ${statusClass}">${statusText}</span>
                                <button class="action-btn" onclick="toggleOccupancy('${flat}')">${translations[lang].toggle}</button>
                            </td>
                            <td>${latestPayment ? latestPayment.name || '—' : '—'}</td>
                            <td>${contact}</td>
                            <td class="amount">${latestPayment ? formatIndianRupees(latestPayment.amount) : '₹0.00'}</td>
                            <td>${latestPayment ? `<button class="action-btn edit-btn" data-payment-idx="${payments.indexOf(latestPayment)}">Edit</button><button class="action-btn delete-btn" data-payment-idx="${payments.indexOf(latestPayment)}">Delete</button>` : ''}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    floorSection.appendChild(table);
                    container.appendChild(floorSection);
                });
            }

            document.querySelectorAll('[data-payment-idx]').forEach(btn => {
                const idx = parseInt(btn.getAttribute('data-payment-idx'));
                if (btn.classList.contains('edit-btn')) btn.onclick = () => editPayment(idx, btn);
                if (btn.classList.contains('delete-btn')) btn.onclick = () => deletePayment(idx);
            });
        }

        function toggleOccupancy(flat) {
            flatStatus[flat] = flatStatus[flat] === 'occupied' ? 'vacant' : 'occupied';
            saveData();
        }

        function openPhotoModal(idx) {
            const expense = expenses[idx];
            if (!expense.photos || expense.photos.length === 0) return;
            currentPhotosArray = expense.photos;
            currentPhotoIndex = 0;
            document.getElementById('modal-photo').src = currentPhotosArray[0];
            document.getElementById('photo-caption').textContent = `Photo 1 of ${currentPhotosArray.length}`;
            document.getElementById('photo-modal').style.display = 'flex';
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').style.display = 'none';
        }

        function prevPhoto() {
            if (currentPhotoIndex > 0) {
                currentPhotoIndex--;
                document.getElementById('modal-photo').src = currentPhotosArray[currentPhotoIndex];
                document.getElementById('photo-caption').textContent = `Photo ${currentPhotoIndex + 1} of ${currentPhotosArray.length}`;
            }
        }

        function nextPhoto() {
            if (currentPhotoIndex < currentPhotosArray.length - 1) {
                currentPhotoIndex++;
                document.getElementById('modal-photo').src = currentPhotosArray[currentPhotoIndex];
                document.getElementById('photo-caption').textContent = `Photo ${currentPhotoIndex + 1} of ${currentPhotosArray.length}`;
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('photo-modal');
            if (event.target === modal) closePhotoModal();
        };

        function editExpense(idx, button) {
            const row = button.parentElement.parentElement;
            const cells = row.children;
            const original = expenses[idx];

            cells[0].innerHTML = `<input type="date" class="editable-input" value="${original.date}">`;
            cells[1].innerHTML = `<input type="text" class="editable-input" value="${original.desc}">`;
            cells[2].innerHTML = `<select class="editable-input">
                <option selected>${original.category}</option>
                <option>Utilities</option><option>Repairs</option><option>Security</option><option>Cleaning</option>
                <option>Staff Salary</option><option>Events</option><option>Other</option>
            </select>`;
            cells[3].innerHTML = `<input type="number" class="editable-input" step="0.01" value="${original.amount}">`;

            let currentPhotos = original.photos ? [...original.photos] : [];

            const photoDiv = document.createElement('div');
            photoDiv.innerHTML = `
                <input type="file" id="edit-exp-photo-${idx}" accept="image/*" multiple style="margin-bottom:10px;">
                <div class="edit-photo-preview" id="edit-photo-preview-${idx}"></div>
            `;
            cells[4].innerHTML = '';
            cells[4].appendChild(photoDiv);

            const previewDiv = document.getElementById(`edit-photo-preview-${idx}`);
            currentPhotos.forEach((src, pidx) => {
                const item = document.createElement('div');
                item.className = 'edit-photo-item';
                item.innerHTML = `
                    <img src="${src}">
                    <button class="action-btn delete-photo-btn" data-pidx="${pidx}">×</button>
                `;
                previewDiv.appendChild(item);
            });

            document.getElementById(`edit-exp-photo-${idx}`).addEventListener('change', e => {
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        currentPhotos.push(ev.target.result);
                        const item = document.createElement('div');
                        item.className = 'edit-photo-item';
                        item.innerHTML = `<img src="${ev.target.result}">`;
                        previewDiv.appendChild(item);
                    };
                    reader.readAsDataURL(file);
                });
            });

            previewDiv.addEventListener('click', e => {
                if (e.target.classList.contains('delete-photo-btn')) {
                    const pidx = parseInt(e.target.dataset.pidx);
                    currentPhotos.splice(pidx, 1);
                    previewDiv.innerHTML = '';
                    currentPhotos.forEach((src, newIdx) => {
                        const item = document.createElement('div');
                        item.className = 'edit-photo-item';
                        item.innerHTML = `
                            <img src="${src}">
                            <button class="action-btn delete-photo-btn" data-pidx="${newIdx}">×</button>
                        `;
                        previewDiv.appendChild(item);
                    });
                }
            });

            button.textContent = 'Save';
            button.className = 'action-btn save-btn';
            button.onclick = () => {
                expenses[idx] = {
                    date: cells[0].querySelector('input').value,
                    desc: cells[1].querySelector('input').value.trim(),
                    category: cells[2].querySelector('select').value,
                    amount: cells[3].querySelector('input').value,
                    photos: currentPhotos
                };
                saveData();
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'action-btn cancel-btn';
            cancelBtn.onclick = () => renderLists();
            cells[5].appendChild(cancelBtn);
        }

        function editPayment(idx, button) {
            const row = button.parentElement.parentElement;
            const cells = row.children;
            const original = payments[idx];
            cells[0].innerHTML = `<input type="date" class="editable-input" value="${original.date}">`;
            cells[1].innerHTML = `<select class="editable-input"><option selected>${original.flat}</option>${allFlats.map(f => `<option>${f}</option>`).join('')}</select>`;
            cells[3].innerHTML = `<input type="text" class="editable-input" value="${original.name || ''}">`;
            cells[4].innerHTML = `<input type="text" class="editable-input" value="${original.contact || ''}">`;
            cells[5].innerHTML = `<input type="number" class="editable-input" step="0.01" value="${original.amount}">`;
            button.textContent = 'Save';
            button.className = 'action-btn save-btn';
            button.onclick = () => {
                const newName = cells[3].querySelector('input').value.trim();
                payments[idx] = {
                    date: cells[0].querySelector('input').value,
                    flat: cells[1].querySelector('select').value,
                    name: newName,
                    contact: cells[4].querySelector('input').value.trim(),
                    amount: cells[5].querySelector('input').value
                };
                if (newName) flatStatus[payments[idx].flat] = 'occupied';
                else flatStatus[payments[idx].flat] = 'vacant';
                saveData();
            };
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'action-btn cancel-btn';
            cancelBtn.onclick = () => renderLists();
            cells[6].appendChild(cancelBtn);
        }

        function deleteExpense(idx) {
            if (confirm("Delete this expense?")) {
                expenses.splice(idx, 1);
                saveData();
            }
        }

        function deletePayment(idx) {
            if (confirm("Delete this payment?")) {
                payments.splice(idx, 1);
                saveData();
            }
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            document.querySelector(`.tab-btn[onclick="openTab('${tabName}')"]`).classList.add('active');
            if (tabName === 'lists') renderLists();
            if (tabName === 'dashboard') renderReports();
        }

        async function generateExpensePDF() {
            const monthKey = document.getElementById('report-month').value || 'all';
            const { exp } = getFilteredData(monthKey);
            const monthTitle = monthKey === 'all' ? 'All Time' : new Date(monthKey + '-01').toLocaleString('default', { month: 'long', year: 'numeric' });
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFontSize(18);
            doc.text("Society Expense Report", 105, 20, { align: "center" });
            doc.setFontSize(12);
            doc.text(`Period: ${monthTitle}`, 105, 30, { align: "center" });

            const tableData = exp.map(e => [
                e.date,
                e.desc,
                e.category,
                formatRupeesNoSymbol(e.amount)
            ]);

            const total = exp.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);

            doc.autoTable({
                head: [['Date', 'Description', 'Category', 'Amount (Rs)']],
                body: tableData,
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219] },
                columnStyles: { 3: { halign: 'right' } }
            });

            doc.setFontSize(14);
            doc.text(`Total Expenses: Rs ${formatRupeesNoSymbol(total)}`, 14, doc.lastAutoTable.finalY + 10);
            doc.save(`Expense_Report_${monthTitle.replace(/ /g, '_')}.pdf`);
        }

        async function generateInvoicePDF() {
            const monthKey = document.getElementById('report-month').value || 'all';
            const { exp, pay } = getFilteredData(monthKey);
            const monthTitle = monthKey === 'all' ? 'All Time' : new Date(monthKey + '-01').toLocaleString('default', { month: 'long', year: 'numeric' });
            const totalExp = exp.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFontSize(18);
            doc.text("Society Maintenance Report", 105, 20, { align: "center" });
            doc.setFontSize(12);
            doc.text(`Period: ${monthTitle}`, 105, 30, { align: "center" });
            doc.text(`Total Expense: Rs ${formatRupeesNoSymbol(totalExp)}`, 105, 38, { align: "center" });

            const tableData = allFlats.map(flat => {
                const flatPayments = pay.filter(p => p.flat === flat);
                const paid = flatPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
                const status = flatStatus[flat] || (flatPayments.some(p => p.name) ? 'Occupied' : 'Vacant');
                const name = flatPayments.length > 0 ? (flatPayments[flatPayments.length - 1].name || '—') : '—';
                return [flat, status, formatRupeesNoSymbol(paid), name];
            });

            doc.autoTable({
                head: [['Flat No.', 'Status', 'Paid (Rs)', 'Owner Name']],
                body: tableData,
                startY: 50,
                theme: 'grid',
                headStyles: { fillColor: [231, 76, 60] },
                columnStyles: { 2: { halign: 'right' } }
            });

            const totalCollected = pay.reduce((s, p) => s + parseFloat(p.amount || 0), 0);
            doc.setFontSize(14);
            doc.text(`Total Collected: Rs ${formatRupeesNoSymbol(totalCollected)}`, 14, doc.lastAutoTable.finalY + 10);
            doc.save(`Maintenance_Report_${monthTitle.replace(/ /g, '_')}.pdf`);
        }

        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newExpense = {
                date: document.getElementById('exp-date').value,
                desc: document.getElementById('exp-desc').value.trim(),
                category: document.getElementById('exp-category').value,
                amount: document.getElementById('exp-amount').value,
                photos: []
            };
            const files = document.getElementById('exp-photo').files;
            if (files.length > 0) {
                const photoPromises = Array.from(files).map(file => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = ev => resolve(ev.target.result);
                    reader.readAsDataURL(file);
                }));
                newExpense.photos = await Promise.all(photoPromises);
            }
            expenses.push(newExpense);
            await saveData();
            e.target.reset();
            alert("Expense added successfully!");
        });

        document.getElementById('payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const flat = document.getElementById('pay-flat').value;
            const name = document.getElementById('pay-vacant').checked ? '' : document.getElementById('pay-name').value.trim();
            const contact = document.getElementById('pay-contact').value.trim();
            payments.push({
                date: document.getElementById('pay-date').value,
                flat: flat,
                name: name,
                contact: contact,
                amount: document.getElementById('pay-amount').value
            });
            if (document.getElementById('pay-vacant').checked) flatStatus[flat] = 'vacant';
            else if (name) flatStatus[flat] = 'occupied';
            await saveData();
            e.target.reset();
            document.getElementById('pay-vacant').checked = false;
            toggleVacant();
            alert("Payment added successfully!");
        });

        function initApp() {
            const savedLang = localStorage.getItem('preferredLanguage') || 'en';
            document.getElementById('language-select').value = savedLang;
            changeLanguage();
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelector('.theme-toggle button').textContent = 'Light Mode';
            }
            populateMonthSelects();
            updateDashboard();
            renderLists();
            renderReports();
            openTab('dashboard');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const loginPage = document.getElementById('login-page');
            const mainApp = document.getElementById('main-app');
            const logoutBtn = document.getElementById('logout-btn');
            if (isLoggedIn) {
                loginPage.style.display = 'none';
                mainApp.style.display = 'block';
                logoutBtn.style.display = 'block';
                loadData();
            } else {
                loginPage.style.display = 'flex';
                mainApp.style.display = 'none';
                logoutBtn.style.display = 'none';
            }

            document.getElementById('login-btn').addEventListener('click', () => {
                const password = document.getElementById('login-password').value.trim();
                if (password === APP_PASSWORD) {
                    localStorage.setItem('isLoggedIn', 'true');
                    loginPage.style.display = 'none';
                    mainApp.style.display = 'block';
                    logoutBtn.style.display = 'block';
                    loadData();
                } else {
                    document.getElementById('login-error').style.display = 'block';
                }
            });

            document.getElementById('login-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('login-btn').click();
            });

            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('isLoggedIn');
                loginPage.style.display = 'flex';
                mainApp.style.display = 'none';
                logoutBtn.style.display = 'none';
            });
        });

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('exp-date').value = today;
        document.getElementById('pay-date').value = today;
    </script>
</body>
</html>
